<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rasheed AI - RAG ( Knowledgebase Management)</title>
    <link rel="icon" href="{{ url_for('static', filename='brand.png') }}">
    <style>
        body { background-color: #2c2f33; color: #ffffff; font-family: Arial, sans-serif; margin: 0; padding: 0; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 30px; background-color: #23272a; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2); }
        .header-left { display: flex; align-items: center; }
        .header-left img { height: 40px; margin-right: 15px; }
        .header-left h1 { font-size: 24px; margin: 0; }
        .container { max-width: 1200px; margin: 40px auto; padding: 20px; }
        .card-row { display: flex; justify-content: space-between; gap: 20px; margin-bottom: 40px; }
        .card { background-color: #23272a; border-radius: 8px; padding: 20px; text-align: center; flex: 1; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .card h2 { font-size: 18px; margin: 0 0 10px; color: #b9bbbe; }
        .card .count { font-size: 36px; font-weight: bold; color: #f04747; }
        .button-group { display: flex; justify-content: center; gap: 15px; margin-bottom: 40px; }
        .btn { background-color: #f04747; color: #ffffff; border: none; padding: 12px 25px; border-radius: 5px; font-size: 16px; cursor: pointer; transition: background-color 0.3s ease; }
        .btn:hover:not(:disabled) { background-color: #d32f2f; }
        .btn-green { background-color: #4CAF50; }
        .btn-green:hover:not(:disabled) { background-color: #45a049; }
        .btn:disabled { background-color: #555; cursor: not-allowed; opacity: 0.5; }
        .file-section { background-color: #23272a; border-radius: 8px; padding: 20px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); overflow-x: auto; }
        .file-section h2 { margin-top: 0; }
        .file-list { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .file-list th, .file-list td { text-align: left; padding: 12px; border-bottom: 1px solid #36393f; }
        .file-list th { color: #b9bbbe; font-size: 14px; }
        .action-btn { background-color: #f04747; color: white; border: none; padding: 6px 12px; cursor: pointer; border-radius: 4px; text-decoration: none; display: inline-block; }
        .action-btn:hover { background-color: #d32f2f; }
        .footer { text-align: center; padding: 20px; font-size: 14px; color: #b9bbbe; margin-top: 40px; }
        .status-section { display: none; text-align: center; margin-top: 20px; padding: 20px; background-color: #23272a; border-radius: 8px; box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3); }
        .status-section h3 { margin-top: 0; color: #ffffff; }
        .brain-loader { width: 50px; height: 50px; background: url("{{ url_for('static', filename='brain_icon.png') }}") no-repeat center center; background-size: contain; animation: pulse 1.5s infinite ease-in-out; margin: 0 auto 10px; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.8; } 100% { transform: scale(1); opacity: 1; } }
        @media (max-width: 768px) {
            .header { flex-direction: column; text-align: center; padding: 15px 10px; }
            .header-left { flex-direction: column; margin-bottom: 10px; }
            .header-left img { margin-right: 0; margin-bottom: 10px; }
            .card-row { flex-direction: column; }
            .button-group { flex-direction: column; gap: 10px; }
            .file-list { width: 100%; border: 0; }
            .file-list thead { display: none; }
            .file-list tr { display: block; margin-bottom: 15px; border: 1px solid #36393f; border-radius: 8px; }
            .file-list td { display: block; text-align: right; padding-left: 50%; position: relative; }
            .file-list td::before { content: attr(data-label); position: absolute; left: 0; width: 50%; padding-left: 10px; font-weight: bold; text-align: left; color: #b9bbbe; }
            .file-section h2 { text-align: center; }
            .upload-form { flex-direction: column; align-items: center; }
            .upload-form .btn { margin-top: 10px; }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-left">
            <img src="{{ url_for('static', filename='brand.png') }}" alt="Rasheed AI Logo">
            <h1>Rasheed AI - RAG Management</h1>
        </div>
    </div>
    <div class="container">
        <div class="card-row">
            <div class="card">
                <h2>Total Files</h2>
                <div class="count">{{ files|length }}</div>
            </div>
            <div class="card">
                <h2>Total Size</h2>
                <div class="count">
                    {% set total_size = 0 %}
                    {% for file in files %}
                        {% set total_size = total_size + file.size.split(' ')[0]|float %}
                    {% endfor %}
                    {{ '%.2f'|format(total_size) }} KB
                </div>
            </div>
            <div class="card">
                <h2>Last Training</h2>
                <div class="count" id="last-indexing">{{ last_trained }}</div>
            </div>
        </div>
        <div class="button-group">
            <button class="btn btn-green" id="train-btn" onclick="trainIndexing()">Train</button>
            <button class="btn" id="delete-all-btn" onclick="confirmDeleteAll()">Delete All Files & Index</button>
        </div>
        <div class="status-section" id="status-section">
            <div class="brain-loader" id="brain-loader"></div>
            <h3 id="status-header"></h3>
            <p id="status-message"></p>
        </div>
        <div class="file-section">
            <h2>Current Files</h2>
            <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" class="upload-form">
                <input type="file" name="file" required style="display: none;" id="file-input">
                <button type="button" class="btn" onclick="document.getElementById('file-input').click();">Upload File</button>
                <span id="file-name" style="margin-left: 15px; color: #b9bbbe;">No file selected</span>
                <button type="submit" class="btn btn-green" style="margin-left: 15px;">Submit</button>
            </form>
            <table class="file-list">
                <thead>
                    <tr>
                        <th>File Name</th>
                        <th>Size</th>
                        <th>Extension</th>
                        <th>Upload Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for file in files %}
                    <tr>
                        <td data-label="File Name">{{ file.name }}</td>
                        <td data-label="Size">{{ file.size }}</td>
                        <td data-label="Extension">{{ file.extension }}</td>
                        <td data-label="Upload Date">{{ file.date }}</td>
                        <td data-label="Actions"><button class="action-btn" onclick="confirmDelete('{{ file.name }}')">Delete</button></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            <div class="text-center mt-4">
                <a href="{{ url_for('download_logs') }}" class="btn btn-green">Download Chat Logs</a>
            </div>
        </div>
    </div>
    <div class="footer">
        Powered by <a href="http://www.rasheed.ai" style="color: #ffffff; text-decoration: none;">www.rasheed.ai</a>
    </div>
    <script>
        let intervalId = null;

        function trainIndexing() {
            const statusSection = document.getElementById('status-section');
            const statusHeader = document.getElementById('status-header');
            const statusMessage = document.getElementById('status-message');
            const trainBtn = document.getElementById('train-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');

            statusSection.style.display = 'block';
            statusHeader.innerText = 'Indexing in progress...';
            statusMessage.innerText = 'Please wait, this may take a moment.';
            statusMessage.style.color = '#ffffff';
            trainBtn.disabled = true;
            deleteAllBtn.disabled = true;

            fetch('/train')
                .then(response => response.json())
                .then(data => {
                    if (data.message) {
                        statusMessage.innerText = data.message;
                        intervalId = setInterval(pollStatus, 3000); // Check status every 3 seconds
                    } else if (data.error) {
                        statusHeader.innerText = 'Indexing Failed';
                        statusMessage.innerText = `Error: ${data.error}`;
                        statusMessage.style.color = 'red';
                        trainBtn.disabled = false;
                        deleteAllBtn.disabled = false;
                    }
                })
                .catch(error => {
                    statusHeader.innerText = 'Indexing Failed';
                    statusMessage.innerText = 'An error occurred while starting the indexing process.';
                    statusMessage.style.color = 'red';
                    trainBtn.disabled = false;
                    deleteAllBtn.disabled = false;
                });
        }

        function pollStatus() {
            const statusHeader = document.getElementById('status-header');
            const statusMessage = document.getElementById('status-message');
            const trainBtn = document.getElementById('train-btn');
            const deleteAllBtn = document.getElementById('delete-all-btn');

            fetch('/check_status')
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'completed') {
                        clearInterval(intervalId);
                        statusHeader.innerText = 'Indexing Completed!';
                        statusMessage.innerText = `Last indexed on ${data.last_trained}.`;
                        statusMessage.style.color = '#4CAF50';
                        document.getElementById('last-indexing').innerText = data.last_trained;
                        trainBtn.disabled = false;
                        deleteAllBtn.disabled = false;
                    } else {
                        statusHeader.innerText = 'Indexing in progress...';
                        statusMessage.innerText = 'Please wait, this may take a moment.';
                    }
                })
                .catch(error => {
                    clearInterval(intervalId);
                    statusHeader.innerText = 'Error';
                    statusMessage.innerText = 'Failed to get indexing status.';
                    statusMessage.style.color = 'red';
                    trainBtn.disabled = false;
                    deleteAllBtn.disabled = false;
                });
        }

        function confirmDelete(filename) {
            if (confirm(`Are you sure you want to delete the file "${filename}"?`)) {
                window.location.href = `/delete/${filename}`;
            }
        }

        function confirmDeleteAll() {
            if (confirm("Are you sure you want to delete ALL files and the entire index? This action cannot be undone.")) {
                window.location.href = "/delete_all";
            }
        }

        document.getElementById('file-input').addEventListener('change', function() {
            const fileName = this.files.length > 0 ? this.files[0].name : 'No file selected';
            document.getElementById('file-name').innerText = fileName;
        });
    </script>
</body>
</html>
